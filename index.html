<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Content Purchase Optimizer · Signal Lab</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#080c10; --surface:#0d1117; --surface2:#161b22; --surface3:#1c2333;
    --border:#21262d; --border2:#30363d;
    --text:#e6edf3; --text-dim:#8b949e; --text-muted:#484f58;
    --green:#3fb950; --green-dim:#196c2e;
    --red:#f85149; --yellow:#d29922; --blue:#388bfd; --purple:#bc8cff;
    --accent:#39d353; --accent-dim:rgba(57,211,83,.08);
    --d-relevance:#388bfd;
    --d-credibility:#d29922;
    --d-freshness:#f85149;
    --d-depth:#bc8cff;
  }
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'IBM Plex Mono',monospace;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden}

  /* TOP BAR */
  .topbar{height:44px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:14px;flex-shrink:0}
  .logo{display:flex;align-items:center;gap:9px;font-size:13px;font-weight:600;letter-spacing:.04em}
  .logo-icon{width:20px;height:20px;background:var(--accent);border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:10px;color:#000;font-weight:700}
  .sep{width:1px;height:18px;background:var(--border2)}
  .badge{font-size:10px;padding:2px 7px;background:rgba(57,211,83,.1);color:var(--accent);border-radius:20px;border:1px solid rgba(57,211,83,.2)}
  .tbar-stat{font-size:10px;color:var(--text-dim);display:flex;align-items:center;gap:5px}
  .tbar-stat span{color:var(--accent);font-weight:500}
  .ml-auto{margin-left:auto}
  .pulse-dot{width:5px;height:5px;border-radius:50%;background:var(--accent);animation:pulse 2s infinite}

  /* LAYOUT */
  .main{flex:1;display:grid;grid-template-columns:280px 1fr 320px;overflow:hidden}
  .panel{border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
  .panel:last-child{border-right:none}
  .ph{height:34px;background:var(--surface2);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 14px;gap:7px;font-size:10px;color:var(--text-dim);letter-spacing:.08em;text-transform:uppercase;flex-shrink:0}
  .ph-dot{width:6px;height:6px;border-radius:50%;background:var(--text-muted)}
  .ph-dot.on{background:var(--accent);box-shadow:0 0 5px var(--accent)}
  .pb{flex:1;overflow-y:auto;padding:14px}
  ::-webkit-scrollbar{width:3px}
  ::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}

  /* INPUTS */
  .lbl{font-size:9px;color:var(--text-muted);letter-spacing:.1em;text-transform:uppercase;margin-bottom:6px;margin-top:13px}
  .lbl:first-child{margin-top:0}
  textarea{width:100%;background:var(--surface2);border:1px solid var(--border2);border-radius:5px;color:var(--text);font-family:'IBM Plex Mono',monospace;font-size:11px;line-height:1.6;padding:10px;resize:none;outline:none;transition:border-color .15s;min-height:72px}
  textarea:focus{border-color:var(--accent)}
  textarea::placeholder{color:var(--text-muted)}
  .run-btn{width:100%;margin-top:13px;padding:10px;background:var(--accent);color:#000;font-family:'IBM Plex Mono',monospace;font-size:11px;font-weight:600;letter-spacing:.08em;border:none;border-radius:5px;cursor:pointer;transition:all .15s;text-transform:uppercase}
  .run-btn:hover{background:#58e86a;transform:translateY(-1px)}
  .run-btn.loading{background:var(--surface3);color:var(--text-muted);cursor:not-allowed;transform:none}
  .divider{height:1px;background:var(--border);margin:12px 0}
  .sc-chip{padding:7px 9px;background:var(--surface2);border:1px solid var(--border2);border-radius:4px;font-size:10px;color:var(--text-dim);cursor:pointer;transition:all .15s;line-height:1.4;margin-bottom:5px}
  .sc-chip:hover{border-color:var(--accent);color:var(--text);background:var(--accent-dim)}
  .sc-tag{font-size:8px;color:var(--text-muted);letter-spacing:.08em;text-transform:uppercase;margin-bottom:2px}

  /* SIGNAL ROWS */
  .dim-section{margin-bottom:20px}
  .dim-header{display:flex;align-items:center;gap:8px;margin-bottom:10px;padding:6px 10px;background:var(--surface2);border-radius:4px;border:1px solid var(--border)}
  .dim-tag{font-size:9px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;padding:2px 8px;border-radius:3px}
  .dim-composed{margin-left:auto;font-size:11px;font-weight:600}
  .dim-desc{font-size:9px;color:var(--text-muted)}

  .sig-row{display:grid;grid-template-columns:1fr 120px 52px;align-items:center;gap:8px;margin-bottom:8px;padding:5px 0;border-bottom:1px solid var(--border)}
  .sig-row:last-child{border-bottom:none}
  .sig-name{font-size:10px;color:var(--text);font-weight:500}
  .sig-source{font-size:8px;color:var(--text-muted);margin-top:1px}
  .bar-wrap{height:5px;background:var(--surface3);border-radius:3px;overflow:hidden}
  .bar-fill{height:100%;border-radius:3px;transition:width .7s cubic-bezier(.4,0,.2,1)}

  /* HOVERABLE VALUE */
  .sig-val-wrap{position:relative;display:inline-block}
  .sig-val{
    font-size:11px;font-weight:600;cursor:help;
    padding:2px 7px;border-radius:3px;
    border:1px solid transparent;
    transition:all .15s;
    display:inline-block;
    white-space:nowrap;
  }
  .sig-val:hover{border-color:var(--border2);background:var(--surface3)}

  /* TOOLTIP */
  .tooltip{
    position:fixed;
    z-index:1000;
    width:240px;
    background:#0d1117;
    border:1px solid var(--border2);
    border-radius:6px;
    padding:10px 12px;
    font-size:10px;
    line-height:1.65;
    color:var(--text-dim);
    pointer-events:none;
    opacity:0;
    transition:opacity .15s;
    box-shadow:0 8px 24px rgba(0,0,0,.6);
  }
  .tooltip.show{opacity:1}
  .tooltip b{color:var(--text);display:block;margin-bottom:4px;font-size:10px}
  .tooltip .t-calc{
    margin-top:6px;padding-top:6px;
    border-top:1px solid var(--border);
    font-size:9px;color:var(--text-muted);
    font-family:'IBM Plex Sans',sans-serif;
  }
  .tooltip .t-val{color:var(--accent);font-weight:600}

  /* FLAG BADGE */
  .sig-flag{font-size:8px;padding:2px 6px;border-radius:3px;font-weight:600;letter-spacing:.05em;white-space:nowrap}

  /* COMPOSED SCORES */
  .composed-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:16px}
  .composed-card{background:var(--surface2);border:1px solid var(--border);border-radius:5px;padding:10px}
  .cc-label{font-size:9px;color:var(--text-muted);letter-spacing:.08em;text-transform:uppercase;margin-bottom:5px;display:flex;align-items:center;gap:5px}
  .cc-val{font-size:22px;font-weight:600;line-height:1}

  /* SOURCE CARDS */
  .src-card{background:var(--surface2);border:1px solid var(--border);border-radius:5px;padding:9px 11px;margin-bottom:7px;display:grid;grid-template-columns:1fr 70px 80px;align-items:center;gap:8px;opacity:0;transform:translateX(-8px);transition:all .3s}
  .src-card.vis{opacity:1;transform:translateX(0)}
  .src-card.sel{border-color:var(--accent);background:var(--accent-dim)}
  .src-card.rej{opacity:.28}
  .src-n{font-size:11px;font-weight:500}
  .src-m{font-size:9px;color:var(--text-muted);margin-top:1px}
  .src-bar{height:3px;background:var(--surface3);border-radius:2px;margin-top:5px;overflow:hidden}
  .src-bf{height:100%;border-radius:2px}

  /* HOVERABLE PRICE */
  .src-price-wrap{position:relative;text-align:right}
  .src-price{
    font-size:11px;font-weight:600;cursor:help;
    padding:2px 6px;border-radius:3px;
    border:1px solid transparent;
    transition:all .15s;
    display:inline-block;
  }
  .src-price:hover{border-color:var(--border2);background:var(--surface3)}
  .src-status{font-size:8px;letter-spacing:.06em;text-transform:uppercase;text-align:right;margin-top:2px}

  /* UTILITY MINI BARS */
  .src-util{text-align:center}
  .src-util-val{font-size:12px;font-weight:600}
  .src-util-lbl{font-size:8px;color:var(--text-muted);margin-top:1px}

  /* RIGHT PANEL */
  .metric-pair{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:7px}
  .mc{background:var(--surface2);border:1px solid var(--border);border-radius:5px;padding:10px 12px}
  .mc-lbl{font-size:9px;color:var(--text-muted);letter-spacing:.08em;text-transform:uppercase;margin-bottom:3px}
  .mc-val{font-size:20px;font-weight:600;line-height:1.1}
  .mc-sub{font-size:10px;color:var(--text-muted);margin-top:2px}
  .savings-wrap{background:var(--surface3);height:6px;border-radius:4px;overflow:hidden;margin:7px 0}
  .savings-fill{height:100%;background:linear-gradient(90deg,var(--green-dim),var(--green));border-radius:4px;width:0%;transition:width .9s cubic-bezier(.4,0,.2,1) .2s}
  .pi{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--accent-dim);border:1px solid rgba(57,211,83,.2);border-radius:4px;margin-bottom:6px;opacity:0;transform:translateY(5px);transition:all .3s}
  .pi.vis{opacity:1;transform:translateY(0)}
  .pi-name{flex:1;font-size:11px}
  .pi-util{font-size:9px;color:var(--text-muted);background:var(--surface3);padding:2px 5px;border-radius:3px}
  .pi-price{font-size:11px;font-weight:600;color:var(--accent)}
  .roi-card{background:var(--surface2);border:1px solid var(--border2);border-radius:5px;padding:12px;margin-top:7px}
  .roi-hdr{font-size:9px;color:var(--text-muted);letter-spacing:.08em;text-transform:uppercase;margin-bottom:8px}
  .roi-row{display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid var(--border);font-size:10px}
  .roi-row:last-child{border-bottom:none}
  .roi-row .rl{color:var(--text-dim)}
  .roi-row .rv{color:var(--text);font-weight:500}
  .roi-row .rv.hi{color:var(--accent);font-size:13px}

  .intent-badge{display:inline-flex;align-items:center;gap:5px;padding:3px 9px;border-radius:3px;font-size:9px;font-weight:600;letter-spacing:.1em;text-transform:uppercase}
  .st{font-size:9px;color:var(--text-muted);letter-spacing:.1em;text-transform:uppercase;margin-bottom:8px;margin-top:14px;display:flex;align-items:center;gap:7px}
  .st::after{content:'';flex:1;height:1px;background:var(--border)}
  .empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:10px;color:var(--text-muted);font-size:10px;text-align:center;padding:20px}
  .empty-icon{font-size:28px;opacity:.25;margin-bottom:3px}

  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  .fade-in{animation:fadeIn .35s ease forwards}
  .src-card:nth-child(1){transition-delay:.03s} .src-card:nth-child(2){transition-delay:.07s}
  .src-card:nth-child(3){transition-delay:.11s} .src-card:nth-child(4){transition-delay:.15s}
  .src-card:nth-child(5){transition-delay:.19s} .src-card:nth-child(6){transition-delay:.23s}
  .src-card:nth-child(7){transition-delay:.27s} .src-card:nth-child(8){transition-delay:.31s}
  .src-card:nth-child(9){transition-delay:.35s} .src-card:nth-child(10){transition-delay:.39s}
  .pi:nth-child(1){transition-delay:.35s} .pi:nth-child(2){transition-delay:.5s} .pi:nth-child(3){transition-delay:.65s}
</style>
</head>
<body>

<!-- GLOBAL TOOLTIP -->
<div class="tooltip" id="tooltip"></div>

<div class="topbar">
  <div class="logo"><div class="logo-icon">⬡</div>Content Purchase Optimizer</div>
  <div class="sep"></div>
  <span style="font-size:10px;color:var(--text-dim);letter-spacing:.06em">Signal Lab</span>
  <span class="badge">v0.3</span>
  <div class="ml-auto" style="display:flex;align-items:center;gap:14px">
    <div class="tbar-stat">runs <span id="totalRuns">0</span></div>
    <div class="tbar-stat">avg saved <span id="avgSavings">—</span></div>
    <div class="sep"></div>
    <div class="tbar-stat"><div class="pulse-dot"></div> live</div>
  </div>
</div>

<div class="main">

<!-- LEFT: INPUT -->
<div class="panel">
  <div class="ph"><div class="ph-dot on"></div>Query Input</div>
  <div class="pb">
    <div class="lbl">Query</div>
    <textarea id="qi" rows="4" placeholder="e.g. What exactly did Powell say this morning about rate cuts?"></textarea>
    <button class="run-btn" id="runBtn" onclick="go()">▶ Optimize</button>
    <div class="divider"></div>
    <div class="lbl">Examples</div>
    <div id="chips"></div>
  </div>
</div>

<!-- MIDDLE: SIGNAL EXTRACTION -->
<div class="panel">
  <div class="ph"><div class="ph-dot" id="midDot"></div>Signal Extraction · 4-Dimension Framework</div>
  <div class="pb" id="midP">
    <div class="empty">
      <div class="empty-icon">⬡</div>
      <div>Run a query to see<br>full signal breakdown<br><br><span style="font-size:9px;opacity:.6">hover any value to see<br>how it was calculated</span></div>
    </div>
  </div>
</div>

<!-- RIGHT: PURCHASE PLAN -->
<div class="panel">
  <div class="ph"><div class="ph-dot" id="rightDot"></div>Purchase Plan · ROI</div>
  <div class="pb" id="rightP">
    <div class="empty">
      <div class="empty-icon">$</div>
      <div>Purchase plan will<br>appear here<br><br><span style="font-size:9px;opacity:.6">hover any price to see<br>how it was estimated</span></div>
    </div>
  </div>
</div>

</div>

<script>
// ═══════════════════════════════════════════════════════════════
// DATA
// ═══════════════════════════════════════════════════════════════

const SCENARIOS = [
  {tag:"Breaking Finance", q:"What exactly did Powell say this morning about rate cuts?"},
  {tag:"Earnings",         q:"TSMC just issued a profit warning — what are the specific details?"},
  {tag:"Market Move",      q:"Why is NVIDIA stock down 8% right now?"},
  {tag:"M&A",              q:"What did Goldman analysts say about the Microsoft Activision deal today?"},
  {tag:"Policy",           q:"EU AI Act compliance requirements for foundation model providers"},
  {tag:"Research",         q:"How does transformer self-attention work?"},
  {tag:"Medical",          q:"Should I take ozempic for weight loss — what do clinical studies show?"},
  {tag:"Tech",             q:"What are the benchmark results for the new Gemini Ultra release?"},
];

let totalRuns=0, sumSavings=0;

// ═══════════════════════════════════════════════════════════════
// TOOLTIP ENGINE — registry-based (no HTML in data attributes)
// ═══════════════════════════════════════════════════════════════

const tip = document.getElementById('tooltip');
let tipTimeout;
const TIP_REGISTRY = {};
let tipIdCounter = 0;

function registerTip(html) {
  const id = 'tip_' + (tipIdCounter++);
  TIP_REGISTRY[id] = html;
  return id;
}

function showTip(el) {
  clearTimeout(tipTimeout);
  const id = el.dataset.tipid;
  if (!id || !TIP_REGISTRY[id]) return;
  tip.innerHTML = TIP_REGISTRY[id];
  tip.classList.add('show');
  positionTip(el);
}

function positionTip(el) {
  const r = el.getBoundingClientRect();
  const tw = 240;
  tip.style.visibility = 'hidden';
  tip.style.display = 'block';
  const th = tip.offsetHeight || 120;
  tip.style.visibility = '';
  let left = r.right + 10;
  let top  = r.top;
  if (left + tw > window.innerWidth - 10) left = r.left - tw - 10;
  if (top + th > window.innerHeight - 10) top = window.innerHeight - th - 10;
  tip.style.left = left + 'px';
  tip.style.top  = Math.max(8, top) + 'px';
}

function hideTip() {
  tipTimeout = setTimeout(() => tip.classList.remove('show'), 120);
}

// Single delegated listener — no inline handlers needed
document.addEventListener('mouseover', e => {
  const el = e.target.closest('[data-tipid]');
  if (el) { clearTimeout(tipTimeout); showTip(el); }
  else if (!e.target.closest('#tooltip')) hideTip();
});
document.addEventListener('mouseout', e => {
  if (!e.target.closest('[data-tipid]') && !e.target.closest('#tooltip')) hideTip();
});

// ═══════════════════════════════════════════════════════════════
// RENDER
// ═══════════════════════════════════════════════════════════════

const INTENT_META = {
  financial_analysis: {label:"Financial Analysis",  color:"#d29922",bg:"rgba(210,153,34,.12)"},
  breaking_news:      {label:"Breaking News",        color:"#f85149",bg:"rgba(248,81,73,.12)"},
  tech_product:       {label:"Tech Coverage",        color:"#388bfd",bg:"rgba(56,139,253,.12)"},
  explainer:          {label:"Research / Explainer", color:"#bc8cff",bg:"rgba(188,140,255,.12)"},
  policy:             {label:"Policy Analysis",      color:"#39d353",bg:"rgba(57,211,83,.12)"},
  medical_clinical:   {label:"Medical / Clinical",   color:"#ff7b72",bg:"rgba(255,123,114,.12)"},
};

const DIM_META = {
  relevance:   {label:"Relevance",   color:"var(--d-relevance)"},
  credibility: {label:"Credibility", color:"var(--d-credibility)"},
  freshness:   {label:"Freshness",   color:"var(--d-freshness)"},
  depth:       {label:"Depth",       color:"var(--d-depth)"},
};

function pct(v){ return (v*100).toFixed(0)+'%'; }

function valColor(v, dimColor){
  return v > .72 ? dimColor : v > .45 ? 'var(--text-dim)' : 'var(--text-muted)';
}

function makeSigVal(v, tipHtml, dimColor, flag){
  const vc = valColor(v, dimColor);
  const pctStr = pct(v);
  const id = registerTip(tipHtml);
  if(flag){
    return `<div style="display:flex;align-items:center;gap:4px">
      <span class="sig-val" style="color:${vc}" data-tipid="${id}">${pctStr}</span>
      <span class="sig-flag" style="background:${flag.bg};color:${flag.color}">${flag.text}</span>
    </div>`;
  }
  return `<span class="sig-val" style="color:${vc}" data-tipid="${id}">${pctStr}</span>`;
}

function sigRow(label, src, sigObj, dimColor, flag){
  const barC = valColor(sigObj.v, dimColor);
  return `
    <div class="sig-row">
      <div>
        <div class="sig-name">${label}</div>
        <div class="sig-source">${src}</div>
      </div>
      <div class="bar-wrap">
        <div class="bar-fill" style="width:${pct(sigObj.v)};background:${barC}"></div>
      </div>
      ${makeSigVal(sigObj.v, sigObj.tip, dimColor, flag)}
    </div>`;
}

// ═══════════════════════════════════════════════════════════════
// BUILD SIGNAL OBJECTS FROM API RESPONSE
// ═══════════════════════════════════════════════════════════════

function buildSigObjects(sigs) {
  const {intent, intentScores, entities, matchedTemplate, minSources} = sigs;
  const R = sigs.relevance;
  const C = sigs.credibility;
  const F = sigs.freshness;
  const D = sigs.depth;

  return {
    relevance: {
      semantic: {v: R.semantic,
        tip: `<b>Semantic Match · ${pct(R.semantic)}</b>Query text compared against 6 intent profile vocabularies using keyword cosine similarity.<div class="t-calc">Top intent: <span class="t-val">${intent.replace(/_/g,' ')}</span> (score: ${intentScores[intent].toFixed(3)})<br>Formula: intersection(query_words, profile_words) / √(|query| × |profile|)<br>Scaled: raw×3.8 + 0.22, capped at 0.98</div>`},
      entityDensity: {v: R.entityDensity,
        tip: `<b>Entity Density · ${pct(R.entityDensity)}</b>Named entities detected in query using regex for capitalized tokens.<div class="t-calc">Entities found: <span class="t-val">${entities.length > 0 ? entities.slice(0,5).join(', ') : 'none'}</span><br>Formula: min(entity_count / 7, 1.0)<br>Source: FB paper §3.1 "entity linking" component</div>`},
      specificity: {v: R.specificity,
        tip: `<b>Specificity · ${pct(R.specificity)}</b>How narrow vs. broad the query is. Specific queries justify paying for exact-match content.<div class="t-calc">Markers checked: Q1–Q4, year references, $amounts, %, IPO, CEO, "exactly", "specific"<br>Triggered: <span class="t-val">${R.specificTriggered ? 'yes — scored 0.88' : 'no — scored by length (' + R.wordCount + ' words)'}</span><br>Narrow queries (0.8+) pay for precision; broad queries (0.3–0.5) can use general sources</div>`},
      templateBoost: {v: R.templateBoost,
        tip: `<b>Template Boost · ${pct(R.templateBoost)}</b>Structural pattern matching — does the query match a known high-value template?<div class="t-calc">Matched template: <span class="t-val">${matchedTemplate ? matchedTemplate.label : 'none'}</span><br>Boost applied: <span class="t-val">${matchedTemplate ? '+' + matchedTemplate.boost : '0 (baseline 0.5)'}</span><br>Source: FB paper §3.1 "Intent Template" — e.g. &lt;company&gt;_earnings_&lt;period&gt;</div>`},
      composed: R.composed,
    },
    credibility: {
      stakes: {v: C.stakes,
        tip: `<b>Stakes Level · ${pct(C.stakes)}</b>Is the user making a decision (high) or just seeking information (low)? High stakes = pay for authoritative sources.<div class="t-calc">High-stakes keywords: "should I", "invest", "treatment", "diagnosis", "legal"<br>Triggered: <span class="t-val">${C.stakesLevel === 'high' ? 'YES (0.95)' : C.stakesLevel === 'medium' ? 'medium (0.68)' : 'no (0.38)'}</span><br>Novel signal — not in FB paper or vLLM. Unique to content purchase optimization.</div>`},
      sensitivity: {v: C.sensitivity,
        tip: `<b>Domain Sensitivity · ${pct(C.sensitivity)}</b>Medical, legal, and financial advice queries require certified authoritative sources regardless of cost.<div class="t-calc">Sensitivity keywords: medical, clinical, legal, financial advice, drug, diagnosis, prescription<br>Triggered: <span class="t-val">${C.sensitivityLevel === 'high' ? 'YES — high sensitivity domain (0.92)' : C.sensitivityLevel === 'finance' ? 'finance domain (0.72)' : 'general query (0.30)'}</span><br>Raises quality floor; free sources penalized in this regime.</div>`},
      corroboration: {v: C.corroboration,
        tip: `<b>Corroboration Need · ${pct(C.corroboration)}</b>How many independent sources are needed? High corroboration = buy ≥2 sources from different publishers.<div class="t-calc">Formula: stakes×0.5 + controversy×0.3 + (breaking?0.25:0)<br>Min sources required: <span class="t-val">${minSources}</span><br>High corroboration prevents over-reliance on single biased source.</div>`},
      controversy: {v: C.controversy,
        tip: `<b>Controversy · ${pct(C.controversy)}</b>Does this topic have multiple valid perspectives that a single source might miss or distort?<div class="t-calc">Controversy keywords: policy, debate, ban, restrict, vs., disagree, dispute<br>Triggered: <span class="t-val">${C.controversyTriggered ? 'YES (0.78)' : 'no (0.28)'}</span><br>High controversy → diversify sources to avoid perspective bias.</div>`},
      composed: C.composed,
    },
    freshness: {
      velocity: {v: F.velocity,
        tip: `<b>Velocity / Trending · ${pct(F.velocity)}</b>How time-sensitive is the content? Drives whether we require real-time sources.<div class="t-calc">Real-time keywords: "today", "this morning", "just", "breaking", "right now"<br>Recent keywords: "this week", "latest", "2026", "Q1 2026"<br>Triggered: <span class="t-val">${F.velocityLevel === 'real-time' ? 'REAL-TIME (1.0)' : F.velocityLevel === 'recent' ? 'RECENT (0.74)' : F.velocityLevel === 'archival' ? 'ARCHIVAL (0.12)' : 'neutral (0.38)'}</span><br>Source: FB paper §3.1 "Trending Detection" component</div>`},
      temporalMarkers: {v: F.temporalMarkers,
        tip: `<b>Temporal Markers · ${pct(F.temporalMarkers)}</b>Explicit time references in the query. More markers = tighter freshness window.<div class="t-calc">Markers extracted: <span class="t-val">${F.timeMarkers.length ? F.timeMarkers.join(', ') : 'none'}</span><br>Formula: velocity + (marker_count × 0.04)<br>Max freshness age derived: <span class="t-val">${F.maxFreshnessHours >= 9999 ? 'unlimited' : F.maxFreshnessHours + ' hours'}</span></div>`},
      eventUrgency: {v: F.eventUrgency,
        tip: `<b>Event Urgency · ${pct(F.eventUrgency)}</b>Specific time-locked events (earnings, rate decisions, IPOs) that have a hard freshness deadline.<div class="t-calc">Event keywords: earnings, IPO, merger, rate decision, profit warning, "down X%"<br>Triggered: <span class="t-val">${F.eventTriggered ? 'YES — event detected (0.82)' : 'no (0.22)'}</span><br>Events require sources published within the event window, not just recently.</div>`},
      decayRate: {v: F.decayRate,
        tip: `<b>Decay Rate · ${pct(F.decayRate)}</b>How fast does this type of content go stale? High decay = content worthless after hours.<div class="t-calc">By intent type:<br>• breaking_news: 1.0 (hourly decay)<br>• financial_analysis: 0.88 (daily)<br>• policy: 0.42 (weekly)<br>• explainer: 0.10 (evergreen)<br>Current intent: <span class="t-val">${intent} → ${F.decayRate}</span></div>`},
      composed: F.composed,
      required: F.required,
      maxFreshnessHours: F.maxFreshnessHours,
      timeMarkers: F.timeMarkers,
    },
    depth: {
      complexity: {v: D.complexity,
        tip: `<b>Query Complexity · ${pct(D.complexity)}</b>Analytical vs. simple factual query. Complex queries need deeper sources, not just headlines.<div class="t-calc">Analytical keywords: "analyze", "impact", "implication", "explain why", "why is"<br>Triggered: <span class="t-val">${D.analyticalTriggered ? 'YES' : 'no'}</span><br>Length factor: ${D.wordCount} words<br>Formula: 0.6×(analytical?0.88:0.35) + 0.4×(length/18)</div>`},
      depthRequired: {v: D.depthRequired,
        tip: `<b>Answer Depth Required · ${pct(D.depthRequired)}</b>Does the user want a headline (quick fact) or a deep-dive analysis?<div class="t-calc">Depth keywords: "comprehensive", "detailed", "specific", "exactly", "full analysis"<br>Triggered: <span class="t-val">${D.depthKeywordsTriggered ? 'YES (0.92)' : D.complexity > 0.62 ? 'inferred from complexity (0.72)' : 'low (0.32)'}</span><br>High depth → penalize short articles; pay for long-form analysis.</div>`},
      questionType: {v: D.questionTypeScore, raw: D.questionType,
        tip: `<b>Question Type (Broder) · ${D.questionType}</b>Classic IR taxonomy from Broder 2002, cited in the FB paper.<div class="t-calc">Types:<br>• <b>Informational</b> — want facts/analysis → buy content (0.65)<br>• <b>Navigational</b> — want specific source → route directly (0.30)<br>• <b>Transactional</b> — want to do something → usually no purchase (0.48)<br>Detected: <span class="t-val">${D.questionType}</span></div>`},
      ambiguity: {v: D.ambiguity,
        tip: `<b>Ambiguity / Multi-angle · ${pct(D.ambiguity)}</b>Does the query need multiple perspectives to resolve? Ambiguous queries need diverse sources.<div class="t-calc">Ambiguity keywords: "versus", "vs.", "or", "different views", "both sides", "depends"<br>Triggered: <span class="t-val">${D.ambiguityTriggered ? 'YES (0.76)' : 'no (0.24)'}</span><br>Novel signal — not in FB paper or vLLM routing.</div>`},
      composed: D.composed,
    },
  };
}

function renderMiddle(res){
  const {sigs, selected, ineligible} = res;
  const {intent, entities, matchedTemplate} = sigs;
  const F  = sigs.freshness;
  const im = INTENT_META[intent]||INTENT_META.explainer;
  const so = buildSigObjects(sigs);

  // Source cards
  const srcCards = res.allScored.map(s => {
    const isSel = selected.find(x=>x.name===s.name);
    const isIne = ineligible.find(x=>x.name===s.name);
    const isRej = res.rejected.find(x=>x.name===s.name);
    const reasonLabel = {too_stale:'stale', low_utility:'low util', over_budget:'over budget', redundant:'redundant', dup_tier:'dup tier'}[(isIne||isRej)?.reason]||'';
    const bColor = isSel ? 'var(--green)' : s.utility>.70 ? 'var(--yellow)' : 'var(--text-muted)';

    // Price tooltip — registered, not stored in attribute
    const priceTipHtml = '<b>Price: ' + (s.price===0?'FREE':'$'+s.price.toFixed(2)) + '</b>' +
      'Source: ' + s.priceSource +
      '<div class="t-calc">' + s.priceDetail + '</div>';
    const priceTipId = registerTip(priceTipHtml);
    const priceDisplay = s.price===0
      ? `<span class="src-price" style="color:var(--green)" data-tipid="${priceTipId}">FREE</span>`
      : `<span class="src-price" style="color:var(--text)" data-tipid="${priceTipId}">$${s.price.toFixed(2)}</span>`;

    return `
      <div class="src-card ${isSel?'sel':(isIne||isRej)?'rej':''}">
        <div>
          <div class="src-n">${s.name}</div>
          <div class="src-m">${s.topics.slice(0,2).join(', ')} · ${s.type}${F.required&&s.freshH>sigs.maxFreshnessHours?' · <span style="color:var(--red)">'+s.freshH+'h lag</span>':''}</div>
          <div class="src-bar"><div class="src-bf" style="width:${pct(s.utility)};background:${bColor}"></div></div>
        </div>
        <div class="src-util">
          <div class="src-util-val" style="color:${bColor}">${pct(s.utility)}</div>
          <div class="src-util-lbl">utility</div>
        </div>
        <div class="src-price-wrap">
          ${priceDisplay}
          <div class="src-status" style="color:${isSel?'var(--green)':(isIne||isRej)?'#484f58':'var(--text-muted)'}">
            ${isSel?'✓ selected':reasonLabel||'—'}
          </div>
        </div>
      </div>`;
  }).join('');

  document.getElementById('midP').innerHTML = `
  <div class="fade-in">

    <!-- INTENT -->
    <div style="margin-bottom:14px">
      <div style="font-size:9px;color:var(--text-muted);letter-spacing:.1em;text-transform:uppercase;margin-bottom:7px">Intent Detected</div>
      <div style="display:flex;align-items:center;gap:7px;flex-wrap:wrap">
        <span class="intent-badge" style="color:${im.color};background:${im.bg};border:1px solid ${im.color}40">● ${im.label}</span>
        ${F.required?'<span class="intent-badge" style="color:var(--red);background:rgba(248,81,73,.1);border:1px solid rgba(248,81,73,.2)">⚡ FRESHNESS CRITICAL</span>':''}
        ${matchedTemplate?`<span class="intent-badge" style="color:var(--text-muted);background:var(--surface3);border:1px solid var(--border2)">${matchedTemplate.label}</span>`:''}
      </div>
      ${entities.length?`<div style="font-size:9px;color:var(--text-muted);margin-top:7px">entities: <span style="color:var(--text-dim)">${entities.slice(0,7).join(', ')}</span></div>`:''}
    </div>

    <!-- COMPOSED SCORES -->
    <div style="font-size:9px;color:var(--text-muted);letter-spacing:.1em;text-transform:uppercase;margin-bottom:8px">Composed Dimension Scores</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:16px">
      ${Object.entries({relevance:so.relevance.composed,credibility:so.credibility.composed,freshness:so.freshness.composed,depth:so.depth.composed}).map(([k,v])=>{
        const dm = DIM_META[k];
        return `<div class="composed-card">
          <div class="cc-label" style="color:${dm.color}">
            <span style="width:5px;height:5px;border-radius:50%;background:${dm.color};display:inline-block;flex-shrink:0"></span>
            ${dm.label}
          </div>
          <div class="cc-val" style="color:${dm.color}">${pct(v)}</div>
          <div style="height:3px;background:var(--surface3);border-radius:2px;margin-top:7px;overflow:hidden">
            <div style="height:100%;width:${pct(v)};background:${dm.color};border-radius:2px;transition:width .8s .1s"></div>
          </div>
        </div>`;
      }).join('')}
    </div>

    <!-- D1: RELEVANCE -->
    <div class="dim-section">
      <div class="dim-header">
        <span class="dim-tag" style="background:rgba(56,139,253,.1);color:var(--d-relevance)">D1 · Relevance</span>
        <span class="dim-desc">how specific & matched must the content be</span>
        <span class="dim-composed" style="color:var(--d-relevance)">${pct(so.relevance.composed)}</span>
      </div>
      ${sigRow('Semantic Match',       'keyword cosine sim vs. intent profiles',       so.relevance.semantic,      'var(--d-relevance)')}
      ${sigRow('Entity Density',       'FB §3.1 entity linking · named tokens found',  so.relevance.entityDensity, 'var(--d-relevance)')}
      ${sigRow('Specificity',          'narrow (high) vs. broad query (low)',           so.relevance.specificity,   'var(--d-relevance)')}
      ${sigRow('Template Match Boost', 'FB §3.1 intent template · structural pattern', so.relevance.templateBoost, 'var(--d-relevance)', matchedTemplate?{text:matchedTemplate.label,color:'var(--text-dim)',bg:'var(--surface3)'}:null)}
    </div>

    <!-- D2: CREDIBILITY -->
    <div class="dim-section">
      <div class="dim-header">
        <span class="dim-tag" style="background:rgba(210,153,34,.1);color:var(--d-credibility)">D2 · Credibility</span>
        <span class="dim-desc">how authoritative the source must be</span>
        <span class="dim-composed" style="color:var(--d-credibility)">${pct(so.credibility.composed)}</span>
      </div>
      ${sigRow('Stakes Level',      'decision-making vs. info-seeking',     so.credibility.stakes,        'var(--d-credibility)',
        so.credibility.stakes.v>.80?{text:'HIGH',color:'#f85149',bg:'rgba(248,81,73,.12)'}:
        so.credibility.stakes.v>.55?{text:'MED', color:'#d29922',bg:'rgba(210,153,34,.12)'}:
        {text:'LOW',color:'#3fb950',bg:'rgba(63,185,80,.12)'})}
      ${sigRow('Domain Sensitivity','medical / legal / financial',          so.credibility.sensitivity,   'var(--d-credibility)')}
      ${sigRow('Corroboration',     'independent sources needed',           so.credibility.corroboration, 'var(--d-credibility)',
        so.credibility.corroboration.v>.60?{text:`≥${sigs.minSources} sources`,color:'#d29922',bg:'rgba(210,153,34,.12)'}:
        {text:'1 source',color:'var(--text-muted)',bg:'var(--surface3)'})}
      ${sigRow('Controversy',       'multiple perspectives required',       so.credibility.controversy,   'var(--d-credibility)')}
    </div>

    <!-- D3: FRESHNESS -->
    <div class="dim-section">
      <div class="dim-header">
        <span class="dim-tag" style="background:rgba(248,81,73,.1);color:var(--d-freshness)">D3 · Freshness</span>
        <span class="dim-desc">how time-sensitive the content must be${F.required?' · <span style="color:var(--red)">max '+sigs.maxFreshnessHours+'h</span>':''}</span>
        <span class="dim-composed" style="color:var(--d-freshness)">${pct(so.freshness.composed)}</span>
      </div>
      ${sigRow('Velocity / Trending', 'FB §3.1 trending detection · time keywords',  so.freshness.velocity,        'var(--d-freshness)',
        so.freshness.velocity.v>=.90?{text:'REAL-TIME',color:'#f85149',bg:'rgba(248,81,73,.12)'}:
        so.freshness.velocity.v>=.60?{text:'RECENT',   color:'#d29922',bg:'rgba(210,153,34,.12)'}:
        {text:'ARCHIVAL',color:'var(--text-muted)',bg:'var(--surface3)'})}
      ${sigRow('Temporal Markers',    'extracted time refs: today / Q1 / year',       so.freshness.temporalMarkers, 'var(--d-freshness)',
        F.timeMarkers.length?{text:F.timeMarkers[0],color:'var(--text-dim)',bg:'var(--surface3)'}:null)}
      ${sigRow('Event Urgency',       'earnings / rate decision / IPO detected',       so.freshness.eventUrgency,    'var(--d-freshness)')}
      ${sigRow('Decay Rate',          'how fast this topic type goes stale',           so.freshness.decayRate,       'var(--d-freshness)')}
    </div>

    <!-- D4: DEPTH -->
    <div class="dim-section">
      <div class="dim-header">
        <span class="dim-tag" style="background:rgba(188,140,255,.1);color:var(--d-depth)">D4 · Depth</span>
        <span class="dim-desc">novel · not in FB paper or vLLM router</span>
        <span class="dim-composed" style="color:var(--d-depth)">${pct(so.depth.composed)}</span>
      </div>
      ${sigRow('Query Complexity',    'analytical language + query length',            so.depth.complexity,     'var(--d-depth)')}
      ${sigRow('Answer Depth Req.',   'headline vs. deep-dive needed',                 so.depth.depthRequired,  'var(--d-depth)')}
      ${sigRow('Question Type',       'Broder 2002 taxonomy (cited in FB paper)',      so.depth.questionType,   'var(--d-depth)',
        {text:so.depth.questionType.raw||'informational',color:'var(--text-dim)',bg:'var(--surface3)'})}
      ${sigRow('Ambiguity / Hedge',   'multiple angles needed to resolve',             so.depth.ambiguity,      'var(--d-depth)')}
    </div>

    <!-- SOURCE SCORING -->
    <div style="font-size:9px;color:var(--text-muted);letter-spacing:.1em;text-transform:uppercase;margin-bottom:8px;display:flex;align-items:center;gap:7px">
      Source Scoring
      <span style="flex:1;height:1px;background:var(--border)"></span>
      <span style="font-size:8px;font-weight:normal">hover price for estimation details</span>
    </div>
    <div id="srcCards">${srcCards}</div>
  </div>`;

  setTimeout(()=>{
    document.querySelectorAll('.src-card').forEach(c=>setTimeout(()=>c.classList.add('vis'),30));
  },80);
}

function fmt$(n){ return n>=1?'$'+n.toFixed(2):'$'+n.toFixed(3) }
function fmtBig(n){
  if(n>=1e9) return '$'+(n/1e9).toFixed(1)+'B';
  if(n>=1e6) return '$'+(n/1e6).toFixed(1)+'M';
  if(n>=1e3) return '$'+Math.round(n/1e3)+'K';
  return '$'+Math.round(n);
}

function renderRight(res){
  const {sigs, selected, smartCost, smartQ, naiveCost, naiveQ, savings, savingsPct} = res;
  const dq = 500000;

  const items = selected.map(s=>`
    <div class="pi">
      <div class="pi-name">${s.name}</div>
      <div class="pi-util">${pct(s.utility)}</div>
      <div class="pi-price">${s.price===0?'FREE':'$'+s.price.toFixed(2)}</div>
    </div>`).join('');

  document.getElementById('rightP').innerHTML = `
  <div class="fade-in">
    <div style="font-size:9px;color:var(--text-muted);letter-spacing:.1em;text-transform:uppercase;margin-bottom:8px">Cost Comparison</div>
    <div class="metric-pair">
      <div class="mc"><div class="mc-lbl">Naive (top-3 authority)</div>
        <div class="mc-val" style="color:var(--red)">${fmt$(naiveCost)}</div>
        <div class="mc-sub">${pct(naiveQ)} avg quality</div>
      </div>
      <div class="mc"><div class="mc-lbl">Optimized</div>
        <div class="mc-val" style="color:var(--green)">${fmt$(smartCost)}</div>
        <div class="mc-sub">${pct(smartQ)} avg quality</div>
      </div>
    </div>
    <div class="mc">
      <div class="mc-lbl">Per-query savings</div>
      <div class="mc-val" style="color:var(--green)">${fmt$(savings)} <span style="font-size:13px">(${savingsPct.toFixed(0)}%)</span></div>
      <div class="savings-wrap"><div class="savings-fill" style="width:${Math.min(savingsPct,100)}%"></div></div>
    </div>

    <div style="font-size:9px;color:var(--text-muted);letter-spacing:.1em;text-transform:uppercase;margin:12px 0 8px">Purchase Plan</div>
    <div id="piList">${items||'<div style="font-size:10px;color:var(--text-muted);padding:6px 0">No paid sources needed — free sources sufficient</div>'}</div>

    <div style="font-size:9px;color:var(--text-muted);letter-spacing:.1em;text-transform:uppercase;margin:12px 0 8px">Signal-Derived Thresholds</div>
    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:5px;padding:4px 10px">
      <div class="roi-row"><span class="rl">Quality floor</span><span class="rv">${pct(sigs.qualityThreshold)} <span style="color:var(--text-muted);font-size:9px">(from credibility)</span></span></div>
      <div class="roi-row"><span class="rl">Max source age</span><span class="rv">${sigs.maxFreshnessHours>=9999?'unlimited':sigs.maxFreshnessHours+'h'} <span style="color:var(--text-muted);font-size:9px">(from freshness)</span></span></div>
      <div class="roi-row"><span class="rl">Min sources</span><span class="rv">${sigs.minSources} <span style="color:var(--text-muted);font-size:9px">(from corroboration)</span></span></div>
    </div>

    <div style="font-size:9px;color:var(--text-muted);letter-spacing:.1em;text-transform:uppercase;margin:12px 0 8px">ROI at Scale</div>
    <div class="roi-card">
      <div class="roi-hdr">at 500K queries / day</div>
      <div class="roi-row"><span class="rl">Daily savings</span><span class="rv">${fmtBig(savings*dq)}</span></div>
      <div class="roi-row"><span class="rl">Monthly savings</span><span class="rv">${fmtBig(savings*dq*30)}</span></div>
      <div class="roi-row"><span class="rl">Annual savings</span><span class="rv hi">${fmtBig(savings*dq*365)}</span></div>
    </div>
  </div>`;

  setTimeout(()=>{
    document.querySelectorAll('.pi').forEach(el=>setTimeout(()=>el.classList.add('vis'),50));
  },100);
}

// ═══════════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════════

async function go(){
  const q = document.getElementById('qi').value.trim();
  if(!q){ document.getElementById('qi').focus(); return; }
  const btn = document.getElementById('runBtn');
  btn.textContent='⟳ Analyzing...'; btn.classList.add('loading');
  document.getElementById('midDot').classList.add('on');
  document.getElementById('rightDot').classList.add('on');
  try {
    const resp = await fetch('/optimize', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({query: q})
    });
    const res = await resp.json();
    renderMiddle(res); renderRight(res);
    totalRuns++;
    sumSavings += res.savingsPct;
    document.getElementById('totalRuns').textContent = totalRuns;
    document.getElementById('avgSavings').textContent = Math.round(sumSavings/totalRuns)+'%';
  } catch(err) { console.error(err); }
  finally {
    btn.textContent='▶ Optimize'; btn.classList.remove('loading');
  }
}

function init(){
  const chips = document.getElementById('chips');
  SCENARIOS.forEach(s=>{
    const d = document.createElement('div');
    d.className='sc-chip';
    d.innerHTML=`<div class="sc-tag">${s.tag}</div>${s.q}`;
    d.onclick=()=>{ document.getElementById('qi').value=s.q; go(); };
    chips.appendChild(d);
  });
  document.getElementById('qi').addEventListener('keydown',e=>{
    if(e.key==='Enter'&&(e.metaKey||e.ctrlKey)) go();
  });
}

init();
</script>
</body>
</html>
